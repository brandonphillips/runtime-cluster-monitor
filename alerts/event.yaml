- alert: HandlerTest
  expr: count(container_start_time_seconds{container_name=~"handler-test.*",job="kubelet"}) BY (node_address_Hostname) > 0
  for: 20s
  labels:
    alertgroup: handler-test
    handler: "true"
    severity: warning
  annotations:
    description: just alert handler test - ignore
    handler: test {{ $labels.node_address_Hostname }}
    summary: handler test

# - alert: ScaleUpRequest
#   expr: (sum(machine_cpu_cores * 0 + ON(node_name) GROUP_LEFT() label_replace(sum(dind_pod_cpu_request) BY (dind_node_name), "node_name", "$1", "dind_node_name", "(.*)")) BY (node_label_agentpool)) / sum(machine_cpu_cores{node_label_agentpool!=""} * 1000) BY (node_label_agentpool) > 0.66
#   for: 2m
#   labels:
#     alertgroup: dind_problem
#     handler: "true"
#     severity: info
#   annotations:
#     description: '{{$labels.node_label_agentpool}} node group scale request'
#     handler: scaleup-asg {{$labels.node_label_agentpool}}
#     summary: '{{$labels.node_label_agentpool}} node group scale request'

- alert: DindVolumeUnused
  expr: (time() -  dind_volume_last_mount_ts{backend_volume_type !="local"} ) / 3600 > 96
  for: 5m
  labels:
    alertgroup: dind_problem
    handler: "true"
    severity: info
  annotations:
    description: Dind volume {{ $labels.backend_volume_id }} of storage class {{ $labels.storage_class }} is unused for more than 4 days
    handler: delete-dind-volume-by-md5id {{ $labels.backend_volume_type }} {{ $labels.backend_volume_id_md5 }}
    summary: Dind volume is unused for more than 4 days
- alert: UnusedVolumeIsNotDeleted
  expr: (time() -  dind_volume_last_mount_ts{backend_volume_type !="local"} ) / 3600 > 120
  for: 5m
  labels:
    alertgroup: dind_problem
    severity: warning
  annotations:
    description: Dind volume {{ $labels.backend_volume_id }} of storage class {{ $labels.storage_class }} wasn't deleted after 4 days
    summary: 'unused volume with TTL more than 4 days has not been deleted yet'
- alert: DindVolumeRareUsed
  expr: dind_pvc_volume_mount_count <= 2 and (time() - dind_pvc_volume_last_mount_ts{backend_volume_type!="local"}) / 3600 > 24 and on() day_of_week() != 6 != 0 != 1
  for: 5m
  labels:
    alertgroup: dind_problem
    handler: "true"
    severity: info
  annotations:
    description: Dind volume {{ $labels.backend_volume_id }} of account {{ $labels.io_codefresh_accountName }} storage class {{ $labels.storage_class }} is unused for more than 1 day and was mounted less then 2 times
    handler: delete-dind-volume-by-md5id {{ $labels.backend_volume_type }} {{ $labels.backend_volume_id_md5 }}
    summary: Dind volume is rare used

- alert: SpotInstanceTerminationSignal
  expr: (up{app=~"dind|runtime"}  and on(node) aws_instance_termination_imminent == 1 ) + on(workflow_url) group_left(pod_name, node) up{app="runtime", pod_name =~"engine-.*"} 
  for: 20s
  labels:
    alertgroup: dind_problem
    handler: "nowait"
    severity: warning
  annotations:
    description: "Spot instance {{ $labels.node }} is going down - sending SIGPWR to engine pod ${{ $labels.pod_name }}"
    handler: signal-pod {{ $labels.namespace }} {{ $labels.pod_name }} SIGTERM
    summary: Spot termination - sending SIGPwR to engine

- alert: SpotInstanceTermination
  expr: aws_instance_termination_imminent == 1
  for: 20s
  labels:
    alertgroup: dind_problem
    handler: "nowait"
    severity: warning
  annotations:
    description: "Spot instance {{ $labels.node }} is going down - cordon node"
    handler: cordon-node {{ $labels.node }}
    summary: Spot termination - cordon node
