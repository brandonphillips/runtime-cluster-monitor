- alert: NodeCPU
  expr: (rate(container_cpu_system_seconds_total{id="/",image=""}[5m]) + rate(container_cpu_user_seconds_total{id="/",image=""}[5m])) * 100 / ON(node) GROUP_LEFT() machine_cpu_cores > 90
  for: 15m
  labels:
    alertgroup: dind_problem
    severity: warning
  annotations:
    description: CPU > 90% {{ $labels.node_label_node_type }} node {{ $labels.node_address_Hostname }} - {{ $labels.node_address_ExternalIP }}, Runtime Env = {{ $labels.runtime_env }}
    summary: Node CPU overloaded
- alert: NodeMemoryLow
  expr: container_memory_usage_bytes{id="/",image="",job="kubelet"} * 100 / container_spec_memory_limit_bytes{id="/",job="kubelet"} > 90
  for: 30m
  labels:
    alertgroup: NodeMemoryLow
    severity: warning
  annotations:
    description: memory usage > 90% {{ $labels.node_label_node_type }} node {{ $labels.node_address_Hostname }} - {{ $labels.node_address_ExternalIP }}, Runtime Env = {{ $labels.runtime_env }}
    summary: Node Memory Low
- alert: NodeStorageExceededCritical
  expr: container_fs_usage_bytes{container_name="",id="/",job="kubelet"} / container_fs_limit_bytes{id="/"} > 0.9
  for: 15m
  labels:
    alertgroup: NodeStorageExceeded
    severity: critical
  annotations:
    description: ' disk {{ $labels.device }} usage more then 95% {{ $labels.node_label_node_type }} node {{ $labels.node_address_Hostname }} - {{ $labels.node_address_ExternalIP }}, Runtime Env = {{ $labels.runtime_env }}'
    summary: Node Storage Exceeded
- alert: KubeNodeScale
  expr: count(up{job="kubelet"}) BY (node_label_kubernetes_io_role, node_label_node_type, node_label_runtime_environment) - count(up{job="kubelet"} OFFSET 5m) BY (node_label_kubernetes_io_role, node_label_node_type, node_label_runtime_environment) != 0
  for: 2m
  labels:
    alertgroup: dind_problem
    severity: info
  annotations:
    description: 'Number of K8s {{ $labels.node_label_kubernetes_io_role }} {{ $labels.node_label_node_type }} {{ $labels.node_label_runtime_environment }} has been changed by {{ $value }} '
    summary: K8s Nodes Scale event
